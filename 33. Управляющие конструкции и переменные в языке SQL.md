**Билет 33. Управляющие конструкции и переменные в языке SQL**

> ⚠️ **Важно**: стандартный SQL не поддерживает управляющие конструкции. Они доступны только в **процедурных расширениях** (PL/pgSQL в PostgreSQL, PL/SQL в Oracle, хранимые процедуры в MySQL).

---

### PostgreSQL (PL/pgSQL)
- **Переменные**: объявляются в блоке `DECLARE`.  
  ```sql
  DO $$
  DECLARE
    user_count INT;
    msg TEXT := 'OK';
  BEGIN
    SELECT COUNT(*) INTO user_count FROM users;
    IF user_count > 100 THEN
      RAISE NOTICE 'Many users: %', user_count;
    END IF;
  END $$;
  ```

- **Управляющие конструкции**:  
  - `IF ... THEN ... ELSIF ... ELSE ... END IF;`  
  - Циклы: `LOOP`, `WHILE`, `FOR`.

- **Особенности**:  
  - Переменные видны только внутри блока.  
  - Используются в функциях, триггерах, анонимных блоках (`DO`).

---

### MySQL
- **Переменные сессий**: `@var` — не требуют объявления.  
  ```sql
  SET @counter = 0;
  SELECT @counter := @counter + 1 AS row_num, name FROM users;
  ```

- **Локальные переменные**: в хранимых процедурах через `DECLARE`.  
  ```sql
  DELIMITER //
  CREATE PROCEDURE test()
  BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE u_name VARCHAR(50);
    -- ...
  END //
  DELIMITER ;
  ```

- **Управляющие конструкции**:  
  - `IF ... THEN ... ELSEIF ... ELSE ... END IF;`  
  - Циклы: `LOOP`, `WHILE`, `REPEAT`.

- **Особенности**:  
  - `@var` — глобальны для сессии.  
  - Локальные переменные — только внутри процедур.

---

### Общие замечания
- В обычных SQL-запросах (вне процедур) **нет переменных и циклов**.
- Для динамических вычислений используйте CTE, оконные функции или прикладной код.
