**Билет 41. Целостность баз данных и многопользовательский доступ**

### Проблемы многопользовательского доступа
- **Грязное чтение**: транзакция читает незафиксированные данные другой транзакции.
- **Неповторяющееся чтение**: повторное чтение строки возвращает другое значение (изменено).
- **Фантомное чтение**: повторный запрос возвращает новые строки (вставка/удаление).
- **Потерянное обновление**: две транзакции обновляют одну строку, одно изменение теряется.

---

### Типы блокировок
- **Shared (S)** — разрешает чтение, запрещает запись. Несколько транзакций могут удерживать S-блокировки.
- **Exclusive (X)** — запрещает чтение и запись другим. Только одна транзакция может удерживать X-блокировку.
- **Intent-блокировки** — сигнализируют о намерении заблокировать ресурс на более низком уровне (например, таблицу → строку).

PostgreSQL использует **MVCC** (много версий), поэтому блокировки применяются только при конфликтах записи.

---

### Уровни изоляции транзакций (SQL-стандарт)
| Уровень               | Грязное чтение | Неповторяющееся | Фантомное |
|-----------------------|----------------|------------------|-----------|
| **Read Uncommitted**  | Да             | Да               | Да        |
| **Read Committed**    | Нет            | Да               | Да        |
| **Repeatable Read**   | Нет            | Нет              | Да*       |
| **Serializable**      | Нет            | Нет              | Нет       |

> *В PostgreSQL `Repeatable Read` предотвращает фантомы благодаря MVCC.

**Установка уровня**:
```sql
BEGIN;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
-- ... запросы
COMMIT;
```

Выбор уровня — компромисс между согласованностью и производительностью.
