**Билет 35. Хранимые процедуры и функции в языке SQL в СУБД PostgreSQL**

### Общий синтаксис

#### Функция (до PostgreSQL 11 — основной способ)
```sql
CREATE [OR REPLACE] FUNCTION имя(параметры)
RETURNS тип
LANGUAGE язык
AS $$
-- тело
$$;
```

#### Процедура (с PostgreSQL 11+)
```sql
CREATE [OR REPLACE] PROCEDURE имя(параметры)
LANGUAGE язык
AS $$
-- тело
$$;
```

### Языки программирования
- **`SQL`** — простые запросы.  
- **`PL/pgSQL`** — процедурное расширение (аналог PL/SQL).  
- Также: `PL/Python`, `PL/Perl`, `C` и др.

### Типы параметров
- **`IN`** — входной (по умолчанию).  
- **`OUT`** — выходной (в функциях — позволяет возвращать несколько значений).  
- **`INOUT`** — комбинированный.  
- Можно указывать без ключевых слов: порядок определяет тип.

> ⚠️ Процедуры вызываются через `CALL` и могут использовать `COMMIT`/`ROLLBACK`.  
> Функции вызываются в выражениях (`SELECT`) и не могут управлять транзакциями.

---

### Пример функции (PL/pgSQL)
Возвращает количество пользователей в возрасте ≥ N:
```sql
CREATE OR REPLACE FUNCTION count_adults(min_age INT)
RETURNS INT
LANGUAGE plpgsql
AS $$
DECLARE
  cnt INT;
BEGIN
  SELECT COUNT(*) INTO cnt FROM users WHERE age >= min_age;
  RETURN cnt;
END;
$$;
-- Вызов: SELECT count_adults(18);
```

### Пример процедуры (PostgreSQL 11+)
Добавляет пользователя и логирует операцию:
```sql
CREATE OR REPLACE PROCEDURE add_user(u_name TEXT)
LANGUAGE plpgsql
AS $$
BEGIN
  INSERT INTO users (name) VALUES (u_name);
  INSERT INTO logs (event) VALUES ('User added: ' || u_name);
  COMMIT; -- допустимо только в процедуре
END;
$$;
-- Вызов: CALL add_user('Алиса');
```

PostgreSQL гибко поддерживает как функции, так и современные процедуры.
