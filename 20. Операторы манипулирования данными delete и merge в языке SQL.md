**Билет 20. Операторы манипулирования данными DELETE и MERGE в языке SQL**

### `DELETE` — удаление строк
**Синтаксис**:  
```sql
DELETE FROM table_name
[WHERE condition]
[RETURNING * | columns];  -- PostgreSQL-расширение
```

**Примеры**:  
— Удаление по условию:  
```sql
DELETE FROM logs WHERE created_at < '2023-01-01';
```
— Удаление всех строк (осторожно!):  
```sql
DELETE FROM temp_table;  -- таблица остаётся, данные — нет
```
— Возврат удалённых записей (PostgreSQL):  
```sql
DELETE FROM sessions WHERE expired = true RETURNING session_id;
```

> ⚠️ Без `WHERE` удаляются **все строки**. Для полного удаления таблицы используйте `TRUNCATE` (быстрее, но не поддерживает `WHERE` и `RETURNING`).

### `MERGE` — условная вставка/обновление (UPSERT)
**Стандарт SQL:2003**, но **PostgreSQL не поддерживает `MERGE`** напрямую. Вместо этого используется `INSERT ... ON CONFLICT`.

**Синтаксис в PostgreSQL (аналог MERGE)**:  
```sql
INSERT INTO table_name (id, name) VALUES (1, 'Alice')
ON CONFLICT (id) DO UPDATE SET name = EXCLUDED.name;
```

**Пример использования**:  
```sql
INSERT INTO users (email, name) VALUES ('bob@example.com', 'Bob')
ON CONFLICT (email) DO UPDATE SET name = EXCLUDED.name;
```

В СУБД с поддержкой `MERGE` (например, Oracle, SQL Server):  
```sql
MERGE INTO target t
USING source s ON (t.id = s.id)
WHEN MATCHED THEN UPDATE SET t.name = s.name
WHEN NOT MATCHED THEN INSERT (id, name) VALUES (s.id, s.name);
```

`MERGE`/`ON CONFLICT` критически важен для идемпотентных операций.
