**Билет 34. Хранимые процедуры и функции в языке SQL в СУБД MySQL**

### Общий синтаксис

#### Хранимая процедура
```sql
DELIMITER //
CREATE PROCEDURE имя_процедуры ([IN|OUT|INOUT] параметр тип, ...)
BEGIN
  -- тело процедуры
END //
DELIMITER ;
```

#### Функция
```sql
DELIMITER //
CREATE FUNCTION имя_функции (параметр тип, ...)
RETURNS тип
READS SQL DATA | DETERMINISTIC | ...
BEGIN
  -- тело функции
  RETURN значение;
END //
DELIMITER ;
```

### Типы параметров
- **`IN`** — входной (по умолчанию).  
- **`OUT`** — выходной (значение возвращается вызывающему коду).  
- **`INOUT`** — входной и выходной одновременно.

> ⚠️ Функции **не могут** иметь `OUT`/`INOUT` параметры и **должны** возвращать скалярное значение.

---

### Пример процедуры
Добавляет пользователя и возвращает его ID:
```sql
DELIMITER //
CREATE PROCEDURE AddUser(
  IN uname VARCHAR(50),
  OUT new_id INT
)
BEGIN
  INSERT INTO users (name) VALUES (uname);
  SET new_id = LAST_INSERT_ID();
END //
DELIMITER ;
-- Вызов: CALL AddUser('Алиса', @id); SELECT @id;
```

### Пример функции
Возвращает количество активных пользователей:
```sql
DELIMITER //
CREATE FUNCTION ActiveUserCount()
RETURNS INT
READS SQL DATA
DETERMINISTIC
BEGIN
  DECLARE cnt INT;
  SELECT COUNT(*) INTO cnt FROM users WHERE active = TRUE;
  RETURN cnt;
END //
DELIMITER ;
-- Вызов: SELECT ActiveUserCount();
```

### Особенности MySQL
- Требуется изменение `DELIMITER`, чтобы избежать конфликта с `;`.  
- Функции можно использовать в `SELECT`, процедуры — только через `CALL`.
